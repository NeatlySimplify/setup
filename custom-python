# ===== Python Dev =====
FROM python:slim-bookworm

ENV HELIX="https://api.github.com/repos/helix-editor/helix/releases/latest"
ENV REPO="https://raw.githubusercontent.com/NeatlySimplify/setup/main"
ENV UV_INSTALL_URL="https://astral.sh/uv/install.sh"

RUN apt-get update && apt-get install -y \
    git curl ripgrep jq && \
    rm -rf /var/lib/apt/lists/*

# Download latest Helix AppImage dynamically
RUN APPIMAGE_URL=$(curl -s "$HELIX" \
    | jq -r '.assets[] | select(.name | endswith(".AppImage")) | .browser_download_url' | head -n 1) && \
    echo "Downloading $APPIMAGE_URL" && \
    curl -L "$APPIMAGE_URL" -o helix.AppImage && \
    chmod +x helix.AppImage && \
    ./helix.AppImage --appimage-extract && \
    mv squashfs-root /opt/helix && \
    ln -s /opt/helix/AppRun /usr/local/bin/hx && \
    rm helix.AppImage


RUN curl --retry 5 --retry-delay 3 -LsSf $UV_INSTALL_URL | env UV_INSTALL_DIR="/usr/local/bin" sh

RUN uv tool install basedpyright; uv tool install ruff

RUN mkdir -p "$HOME/.config/helix/"

RUN curl --retry 5 --retry-delay 3 -fsSL "$REPO/helix-lsp.toml" -o "$HOME/.config/helix/languages.toml"
RUN curl --retry 5 --retry-delay 3 -fsSL "$REPO/helix-ignore" -o "$HOME/.config/helix/.ignore"

WORKDIR /home/app
ENTRYPOINT ["hx"]

